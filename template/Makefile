# PTM Pipeline Makefile
# Generated by ptm-pipeline init

# Configuration
CONFIG := ptm_config.yaml
SNAKEFILE := Snakefile
CORES := 1

# PTM-pipeline source: git URL or local path
# Override with: make install PTM_PIPELINE_SRC=/path/to/ptm-pipeline
PTM_PIPELINE_SRC := git+https://github.com/wolski/ptm-pipeline

# Pipeline targets
.PHONY: all dry-run clean help install upgrade validate

all: ## Run the full pipeline
	snakemake -s $(SNAKEFILE) --configfile $(CONFIG) -j$(CORES) all

dry-run: ## Show what would be executed (dry-run)
	snakemake -s $(SNAKEFILE) --configfile $(CONFIG) -n all

validate: ## Validate project setup
	ptm-pipeline validate .

clean: ## Remove all output files (keeps config)
	snakemake -s $(SNAKEFILE) --configfile $(CONFIG) --delete-all-output
	rm -rf .snakemake *.zip

clean-all: ## Clean slate - remove everything for fresh init
	rm -rf PTM_* .snakemake *.zip
	rm -rf src Snakefile helpers.py ptm_config.yaml

# Pipeline management
init: ## (Re)initialize pipeline in this directory
	ptm-pipeline init .
install: ## Install ptm-pipeline tool
	uv tool install $(PTM_PIPELINE_SRC)

upgrade: ## Upgrade ptm-pipeline to latest version (reinstall)
	uv tool install --reinstall $(PTM_PIPELINE_SRC)

update: ## Update pipeline files (keeps config)
	ptm-pipeline update .

# Help
help: ## Show this help
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

.DEFAULT_GOAL := help
