---
title: "PTM-SEA Analysis"
subtitle: "`r params$analysis_type`"
author: "FGCZ"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  xlsx_file: "PTM_DPA/Result_DPA.xlsx"
  sheet: "combinedSiteProteinData"
  stat_column: "statistic.site"
  analysis_type: "DPA"
  output_dir: "PTM_DPA/PTMSEA"
  trim_to: 15
  ptmsigdb_file: "data/ptmsigdb/ptmsigdb_filtered_KINASE_PATH_15mer.rds"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 12,
  fig.height = 8
)
```

# Overview

**PTM-SEA** (Post-Translational Modification Signature Enrichment Analysis) for **`r params$analysis_type`** analysis.

PTM-SEA uses flanking sequences and PTMsigDB signatures to infer kinase activities from phosphoproteomics data via ClusterProfiler's GSEA.

**Analysis Type:** `r params$analysis_type`

- **DPA**: Differential PTM Abundance - raw phosphosite changes (includes protein abundance effects)
- **DPU**: Differential PTM Usage - protein-normalized changes (true stoichiometry changes)
- **CF**: CorrectFirst - alternative protein-correction approach

# Load Libraries and Data

```{r load_libraries}
library(prophosqua)
library(clusterProfiler)
library(dplyr)
library(DT)
library(enrichplot)
library(fgsea)
library(forcats)
library(purrr)
library(readxl)
library(writexl)
library(ggplot2)

# Load shared visualization utilities
source("src/enrichment_viz_utils.R")

# Load development version if available
if (file.exists("~/projects/prophosqua")) {
  devtools::load_all("~/projects/prophosqua", quiet = TRUE)
}
```

```{r load_data}
# Read data from Excel
data <- readxl::read_xlsx(params$xlsx_file, sheet = params$sheet)

data_info <- tibble(

  Property = c("Input File", "Sheet", "Stat Column", "Rows", "Columns", "Contrasts"),
  Value = c(basename(params$xlsx_file), params$sheet, params$stat_column,
            nrow(data), ncol(data),
            paste(unique(data$contrast), collapse = ", "))
)
knitr::kable(data_info, caption = "Input Data Summary")
```

# Load PTMsigDB Signatures

```{r load_ptmsigdb}
# Load pre-filtered PTMsigDB (KINASE + PATH categories only)
# PERT and DISEASE categories are excluded
# Generated by: Rscript src/prep_ptmsigdb.R

ptmsigdb_file <- params$ptmsigdb_file
if (!file.exists(ptmsigdb_file)) {
  stop("Pre-filtered PTMsigDB file not found: ", ptmsigdb_file,
       "\nRun: Rscript src/prep_ptmsigdb.R first")
}

# Load pathways (RDS is faster than GMT)
if (grepl("\\.rds$", ptmsigdb_file)) {
  pathways <- readRDS(ptmsigdb_file)
  message("Loaded ", length(pathways), " pathways from RDS")
} else {
  pathways <- fgsea::gmtPathways(ptmsigdb_file)
  message("Loaded ", length(pathways), " pathways from GMT")
}

# Count categories
n_kinase <- sum(grepl("^KINASE-", names(pathways)))
n_path <- sum(grepl("^PATH-", names(pathways)))

# Summary table
ptmsigdb_summary <- tibble(
  Property = c("Source File", "Total Signatures", "KINASE signatures", "PATH signatures", "Unique Sites"),
  Value = c(basename(ptmsigdb_file), length(pathways), n_kinase, n_path,
            length(unique(unlist(pathways))))
)
knitr::kable(ptmsigdb_summary, caption = "PTMsigDB Signature Database Summary")
```

# Overlap Statistics

```{r overlap_stats}
# Our data: unique flanking sequences (trimmed to match pathways)
our_sequences <- data |>
  pull(SequenceWindow) |>
  trimws() |>
  toupper() |>
  unique()
our_sequences_trimmed <- our_sequences |>
  map_chr(~prophosqua:::trim_flanking_seq(.x, trim_to = params$trim_to))
our_site_ids <- paste0(our_sequences_trimmed, "-p")
n_our_sites <- n_distinct(our_site_ids)

# PTMsigDB: unique site IDs (strip ;u/;d for comparison)
ptmsigdb_ids_raw <- pathways |>
  unlist() |>
  unique()
ptmsigdb_ids_stripped <- ptmsigdb_ids_raw |>
  gsub(";[ud]$", "", x = _) |>
  unique()
n_ptmsigdb_sites <- length(ptmsigdb_ids_stripped)

# Overlap
overlap_ids <- intersect(unique(our_site_ids), ptmsigdb_ids_stripped)
n_overlap <- length(overlap_ids)

overlap_stats <- tibble(
  Metric = c("Our data (unique sequences)", "PTMsigDB (unique site IDs)", "Overlap",
             "% of our sites in PTMsigDB", "% of PTMsigDB sites in our data"),
  Value = c(n_our_sites, n_ptmsigdb_sites, n_overlap,
            round(100 * n_overlap / n_our_sites, 2),
            round(100 * n_overlap / n_ptmsigdb_sites, 2))
)
knitr::kable(overlap_stats, caption = paste0("Overlap Statistics (", params$trim_to, "-mer)"))
```

# Prepare Rank Data

```{r prep_data}
# Prepare ranks using prophosqua (trim_to must match pathways)
prep <- ptmsea_data_prep(
  data = data,
  stat_column = params$stat_column,
  seq_window_col = "SequenceWindow",
  contrast_col = "contrast",
  trim_to = as.character(params$trim_to)
)

prep_info <- tibble(
  Contrast = names(prep$ranks),
  Sites = map_int(prep$ranks, length)
)
knitr::kable(prep_info, caption = paste(params$analysis_type, "Contrasts Prepared"))

# Count dropped sequences (handle empty lists/NULL values)
n_dropped <- 0
if (length(prep$dropped) > 0) {
  n_dropped <- sum(map_int(prep$dropped, ~{
    if (is.null(.x) || length(.x) == 0) return(0L)
    if (is.data.frame(.x)) return(nrow(.x))
    return(length(.x))
  }))
}

if (n_dropped > 0) {
  message("Note: ", n_dropped, " duplicate sequences were dropped.")
}
```

# Run PTM-SEA (GSEA)

```{r run_ptmsea}
results <- run_ptmsea(
  ranks_list = prep$ranks,
  pathways = pathways,
  min_size = 10,  # Require at least 10 matches between rank file and geneset
  max_size = 500,
  n_perm = 1000,
  pvalueCutoff = 0.25  # Relaxed for visualization; filter later
)

results_info <- tibble(
  Contrast = names(results),
  `Total Pathways` = map_int(results, ~nrow(.x@result)),
  `FDR < 0.1` = map_int(results, ~sum(.x@result$p.adjust < 0.1, na.rm = TRUE)),
  `FDR < 0.05` = map_int(results, ~sum(.x@result$p.adjust < 0.05, na.rm = TRUE))
)
knitr::kable(results_info, caption = paste(params$analysis_type, "PTM-SEA Results Summary"))
```

# Results by Contrast {.tabset .tabset-pills}

```{r contrastPlots, results='asis', fig.height=8}
# Extract all results into data frame using shared function
all_clean <- extract_gsea_results(results) |>
  mutate(
    pathway = ID,
    pathway_short = gsub("^(KINASE|PERT|PATH|DISEASE)-PSP_", "", ID) |>
      substr(1, 40)
  )

for (ctr in unique(all_clean$contrast)) {
  cat("\n\n## ", ctr, "\n\n")

  ctr_data <- all_clean |> filter(contrast == ctr)
  n_sig <- sum(ctr_data$p.adjust < 0.1, na.rm = TRUE)
  cat("**Significant pathways (FDR < 0.1):** ", n_sig, "\n\n")

  # Using shared dotplot function
  p <- plot_enrichment_dotplot(
    ctr_data,
    item_col = "pathway_short",
    fdr_col = "p.adjust",
    title = paste0(params$analysis_type, " - ", ctr),
    subtitle = "Top 30 pathways by FDR"
  )
  print(p)
  cat("\n\n")

  # Significant pathways table
  cat("### Significant Pathways\n\n")
  sig_table <- ctr_data |>
    filter(p.adjust < 0.1) |>
    select(pathway_short, NES, pvalue, FDR = p.adjust, setSize) |>
    arrange(FDR) |>
    mutate(across(where(is.numeric), ~round(.x, 4)))
  print(htmltools::tagList(
    DT::datatable(sig_table,
                  extensions = 'Buttons',
                  options = list(pageLength = 15, scrollX = TRUE,
                                 dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel')))
  ))
  cat("\n\n")
}
```

# clusterProfiler Dotplots {.tabset .tabset-pills}

## Combined Dotplot

```{r combined_dotplot, fig.width=14, fig.height=10}
merged_results <- merge_result(results)
dotplot(merged_results, showCategory = 15,
        title = paste(params$analysis_type, "PTM-SEA (All Contrasts)")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Individual Contrasts

```{r individual_plots, fig.width=14, fig.height=10, results='asis'}
for (ct in names(results)) {
  cat("\n\n### ", ct, "\n\n")

  res <- results[[ct]]

  # Check if there are any results to plot (dotplot fails on empty data)
  n_results <- nrow(res@result)
  if (n_results == 0) {
    cat("No pathways met the pvalue cutoff for this contrast.\n\n")
    next
  }

  p <- dotplot(res, showCategory = 15, title = ct) +
    theme(axis.text.y = element_text(size = 8))
  print(p)

  # Show top pathways table
  top_res <- res@result |>
    as_tibble() |>
    filter(p.adjust < 0.25) |>
    arrange(pvalue) |>
    head(10) |>
    select(ID, NES, pvalue, p.adjust, setSize) |>
    mutate(
      NES = round(NES, 3),
      pvalue = signif(pvalue, 3),
      p.adjust = signif(p.adjust, 3)
    )
  print(htmltools::tagList(
    DT::datatable(top_res,
                  extensions = 'Buttons',
                  options = list(pageLength = 10, scrollX = TRUE,
                                 dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel')),
                  caption = paste("Top Pathways -", ct))
  ))
  cat("\n\n")
}
```


# Summary Heatmap

```{r summary_heatmap, fig.width=12, fig.height=10}
stopifnot(
 "No GSEA results - check min_size parameter and sequence overlap" = nrow(all_clean) > 0
)

# Using shared heatmap function with pathway_short labels
plot_enrichment_heatmap(
  all_clean,
  item_col = "ID",
  fdr_col = "p.adjust",
  n_top = 25,
  item_label_col = "pathway_short",
  title = paste0("PTM-SEA Summary - ", params$analysis_type)
)
```

# Volcano Plot

```{r volcano_plot, fig.width=12, fig.height=8}
# Using shared volcano function
plot_enrichment_volcano(
  all_clean,
  item_col = "pathway_short",
  fdr_col = "p.adjust",
  title = paste(params$analysis_type, "- PTM-SEA Volcano Plots")
)
```

# Export All GSEA Plots to PDF

```{r export_gsea_pdf, results='hide'}
# Export all GSEA enrichment plots to PDF using shared function
pdf_file <- file.path(params$output_dir, paste0("GSEA_plots_", params$analysis_type, ".pdf"))
n_gsea_plots <- export_gsea_plots_pdf(
  results, pdf_file,
  prefix_pattern = "^(KINASE|PERT|PATH|DISEASE)-PSP_"
)
cat("Exported", n_gsea_plots, "GSEA plots to:", pdf_file, "\n")
```

# GSEA Enrichment Plots {.tabset .tabset-pills}

Showing top 10 plots per contrast. **All `r n_gsea_plots` plots exported to PDF:** `r basename(pdf_file)`

```{r gsea_example_plots, results='asis', fig.width=10, fig.height=6}
for (ct in names(results)) {
  cat("\n\n## ", ct, " {.tabset}\n\n")

  res <- results[[ct]]
  top10 <- res@result |>
    as_tibble() |>
    arrange(pvalue) |>
    head(10) |>
    pull(ID)

  for (i in seq_along(top10)) {
    geneset <- top10[i]
    pathway_short <- gsub("^(KINASE|PERT|PATH|DISEASE)-PSP_", "", geneset)
    cat("\n\n### ", pathway_short, "\n\n")

    row <- res@result |>
      as_tibble() |>
      filter(ID == geneset)
    nes_val <- round(row$NES, 2)
    fdr <- signif(row$p.adjust, 2)

    p <- gseaplot2(res, geneSetID = geneset,
      title = paste0(pathway_short, " (NES=", nes_val, ", FDR=", fdr, ")"))
    print(p)
    cat("\n\n")
  }
}
```

# All Results

```{r allResults}
# All pathways across all contrasts
all_results_dt <- all_results |>
  select(contrast, pathway = ID, NES, pvalue, FDR = p.adjust, setSize) |>
  arrange(contrast, FDR) |>
  mutate(across(where(is.numeric), ~round(.x, 4)))

DT::datatable(all_results_dt,
  filter = "top",
  extensions = 'Buttons',
  options = list(pageLength = 15, scrollX = TRUE,
                 dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel')),
  caption = "All pathways across all contrasts")
```

# Export Results

```{r export}
# Create output directory
dir.create(params$output_dir, recursive = TRUE, showWarnings = FALSE)

# Prepare export data
export_data <- all_results |> arrange(contrast, pvalue)

export_list <- list(all_results = export_data)

# Add per-contrast sheets
for (ct in unique(export_data$contrast)) {
  sheet_name <- gsub("[^a-zA-Z0-9_]", "_", substr(ct, 1, 31))
  export_list[[sheet_name]] <- export_data |> filter(contrast == ct)
}

# Add significant results sheet
export_list[["significant_FDR10"]] <- export_data |> filter(p.adjust < 0.1)

# Write Excel
xlsx_file <- file.path(params$output_dir, paste0("PTMSEA_", params$analysis_type, "_results.xlsx"))
writexl::write_xlsx(export_list, xlsx_file)

# Save RDS with full results objects
rds_file <- file.path(params$output_dir, paste0("PTMSEA_", params$analysis_type, "_results.rds"))
saveRDS(results, rds_file)

# Export summary
export_summary <- tibble(
  Output = c("Excel results", "RDS object"),
  File = c(xlsx_file, rds_file),
  Size = c(
    paste(round(file.size(xlsx_file) / 1024, 1), "KB"),
    paste(round(file.size(rds_file) / 1024, 1), "KB")
  )
)
knitr::kable(export_summary, caption = "Exported Files")
```

# Session Info

```{r sessionInfo}
sessionInfo()
```
