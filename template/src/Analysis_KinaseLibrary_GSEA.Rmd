---
title: "Kinase Library: Kinase Activity Inference from Phosphoproteomics Data"
subtitle: "`r params$analysis_type`"
author: "FGCZ"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  xlsx_file: "PTM_DPA/Result_DPA.xlsx"
  term2gene_file: "PTM_DPA/KinaseLib/term2gene.csv"
  analysis_type: "DPA"
  output_dir: "PTM_DPA/KinaseLib"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 12,
  fig.height = 10
)
```

## Introduction

This report demonstrates kinase activity inference using the **Kinase Library** motif predictions. Unlike PTMsigDB (which uses curated kinase-substrate relationships), Kinase Library predicts kinase-substrate assignments based on position-specific scoring matrices (PSSMs) derived from peptide library screens.

We use the `term2gene.csv` file generated by the `scan-motifs` CLI, which contains kinase-sequence assignments.

**Approach:** GSEA (Gene Set Enrichment Analysis) using ranked phosphosite statistics.

## Analysis Details

| Parameter | Value |
|-----------|-------|
| Analysis Type | `r params$analysis_type` |
| Excel File | `r params$xlsx_file` |
| Term2Gene File | `r params$term2gene_file` |

## Load Data and Kinase Library Predictions

```{r load-packages}
library(clusterProfiler)
library(dplyr)
library(tidyr)
library(readxl)
library(ggplot2)
library(enrichplot)
library(purrr)
library(forcats)
library(writexl)
library(patchwork)
library(DT)
```

```{r load-data}
# Column configuration per analysis type
col_config <- list(
  DPA = list(sheet = "combinedSiteProteinData", stat_col = "statistic.site", diff_col = "diff.site"),
  DPU = list(sheet = "combinedStats", stat_col = "tstatistic_I", diff_col = "diff_diff"),
  CF  = list(sheet = "results", stat_col = "statistic", diff_col = "diff_diff")
)

config <- col_config[[params$analysis_type]]

# Load differential analysis data
data <- read_xlsx(params$xlsx_file, sheet = config$sheet)

# Ensure SequenceWindow column exists
if (!"SequenceWindow" %in% names(data) && "PTM_FlankingRegion" %in% names(data)) {
  data <- data |> rename(SequenceWindow = PTM_FlankingRegion)
}

data_info <- tibble(
  Property = c("Rows", "Columns", "Contrasts"),
  Value = c(nrow(data), ncol(data),
            paste(unique(data$contrast), collapse = ", "))
)
knitr::kable(data_info, caption = "Differential Analysis Data")
```

```{r load-kinase-library}
# Load term2gene from scan-motifs output
term2gene <- read.csv(params$term2gene_file, stringsAsFactors = FALSE)

kl_info <- tibble(
  Property = c("Total assignments", "Unique kinases", "Unique sequences"),
  Value = c(nrow(term2gene), n_distinct(term2gene$term), n_distinct(term2gene$gene))
)
knitr::kable(kl_info, caption = "Kinase Library Predictions")

# IMPORTANT: Kinase Library sequences have lowercase letters for phosphorylated residues
# (e.g., "PETITIRsGPPSPLP"). Convert to uppercase to match our data.
term2gene <- term2gene |>
  mutate(gene = toupper(gene))

# Keep as TERM2GENE format for clusterProfiler GSEA
term2gene_df <- term2gene |>
  select(term, gene)
```

## Kinase-Substrate Assignment Statistics

```{r assignment-stats}
our_sequences <- data |>
  pull(SequenceWindow) |>
  trimws() |>
  toupper() |>
  unique()
assigned_sequences <- unique(term2gene$gene)
overlap_seqs <- intersect(our_sequences, assigned_sequences)

assignment_stats <- tibble(
  Metric = c("Phosphosites in differential analysis",
             "Sites with kinase assignments",
             "Sites usable for GSEA",
             "Coverage (%)"),
  Value = c(length(our_sequences),
            length(assigned_sequences),
            length(overlap_seqs),
            round(100 * length(overlap_seqs) / length(our_sequences), 1))
)
knitr::kable(assignment_stats, caption = "Assignment Statistics")
```

```{r kinase-stats}
# Calculate kinase set sizes from term2gene
kinase_sizes <- term2gene_df |>
  count(term, name = "size")

kinase_overlap <- term2gene_df |>
  filter(gene %in% our_sequences) |>
  count(term, name = "overlap")

kinase_stats <- tibble(
  Metric = c("Number of kinases", "Mean substrates/kinase", "Median substrates/kinase",
             "Range (min-max)", "Mean substrates in our data",
             "Kinases with >= 15 substrates"),
  Value = c(nrow(kinase_sizes),
            round(mean(kinase_sizes$size)),
            median(kinase_sizes$size),
            paste(min(kinase_sizes$size), "-", max(kinase_sizes$size)),
            round(mean(kinase_overlap$overlap, na.rm = TRUE)),
            sum(kinase_overlap$overlap >= 15, na.rm = TRUE))
)
knitr::kable(kinase_stats, caption = "Kinase Set Size Distribution")
```

## Prepare Ranked Lists

```{r prepare-ranks}
# Get statistic column name
stat_col <- config$stat_col

contrasts <- unique(data$contrast)

# Prepare ranked lists using t-statistic
# Names must match sequences in term2gene
ranks <- contrasts |>
  set_names() |>
  map(function(ct) {
    data |>
      filter(contrast == ct) |>
      mutate(seq = toupper(trimws(SequenceWindow))) |>
      filter(!is.na(.data[[stat_col]])) |>
      distinct(seq, .keep_all = TRUE) |>
      arrange(desc(.data[[stat_col]])) |>
      (\(df) setNames(df[[stat_col]], df$seq))()
  })

ranks_info <- tibble(
  Contrast = names(ranks),
  Sites = map_int(ranks, length)
)
knitr::kable(ranks_info, caption = paste(params$analysis_type, "Ranks Prepared"))
```

## GSEA Analysis

```{r run-gsea}
gsea_results <- names(ranks) |>
  set_names() |>
  map(function(ct) {
    GSEA(
      geneList = ranks[[ct]],
      TERM2GENE = term2gene_df,
      minGSSize = 15,
      maxGSSize = 5000,
      pvalueCutoff = 0.25,
      verbose = FALSE
    )
  })

gsea_info <- tibble(
  Contrast = names(gsea_results),
  `Significant Kinases (FDR < 0.25)` = map_int(gsea_results, ~sum(.x@result$p.adjust < 0.25, na.rm = TRUE))
)
knitr::kable(gsea_info, caption = paste(params$analysis_type, "GSEA Results Summary"))
```

# Results by Contrast {.tabset .tabset-pills}

```{r contrastPlots, results='asis', fig.height=8}
# Extract all results into data frame
all_clean <- names(gsea_results) |>
  map_dfr(function(ct) {
    gsea_results[[ct]]@result |>
      as_tibble() |>
      mutate(contrast = ct)
  }) |>
  mutate(
    kinase = ID,
    neg_log_fdr = -log10(pmax(p.adjust, 1e-10)),
    direction = case_when(NES > 0 ~ "Up", NES < 0 ~ "Down", TRUE ~ "NS"),
    significant = p.adjust < 0.1
  )

for (ctr in unique(all_clean$contrast)) {
  cat("\n\n## ", ctr, "\n\n")

  ctr_data <- all_clean |> filter(contrast == ctr)
  n_sig <- sum(ctr_data$p.adjust < 0.1, na.rm = TRUE)
  cat("**Significant kinases (FDR < 0.1):** ", n_sig, "\n\n")

  plot_data <- ctr_data |>
    arrange(p.adjust) |>
    head(30) |>
    mutate(kinase = fct_reorder(kinase, NES))

  p <- ggplot(plot_data, aes(x = NES, y = kinase)) +
    geom_point(aes(size = neg_log_fdr, color = NES, alpha = significant)) +
    scale_color_gradient2(low = "blue", mid = "grey80", high = "red", midpoint = 0) +
    scale_size_continuous(name = "-log10(FDR)", range = c(2, 8)) +
    scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.4), guide = "none") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
    theme_bw() +
    theme(axis.text.y = element_text(size = 9)) +
    labs(
      title = paste0(params$analysis_type, " - ", ctr),
      subtitle = "Top 30 kinases by FDR",
      x = "Normalized Enrichment Score (NES)",
      y = ""
    )
  print(p)
  cat("\n\n")

  # Significant kinases table
  cat("**Significant Kinases (FDR < 0.1):**\n\n")
  sig_table <- ctr_data |>
    filter(p.adjust < 0.1) |>
    select(kinase, NES, pvalue, FDR = p.adjust, setSize) |>
    arrange(FDR) |>
    mutate(across(where(is.numeric), ~round(.x, 4)))
  print(htmltools::tagList(
    DT::datatable(sig_table,
                  extensions = 'Buttons',
                  options = list(pageLength = 15, scrollX = TRUE,
                                 dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel')))
  ))
  cat("\n\n")
}
```

# clusterProfiler Dotplots {.tabset .tabset-pills}

### Merged Dotplot

```{r merged-dotplot, fig.width=14, fig.height=10}
merged <- merge_result(gsea_results)
dotplot(merged, showCategory = 15,
        title = paste(params$analysis_type, "GSEA - Kinase Library (FDR < 0.25)")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Individual Contrasts

```{r individual-dotplots, fig.width=14, fig.height=10}
plots <- names(gsea_results) |>
  map(function(ct) {
    res <- gsea_results[[ct]]@result
    # Skip if no results
    if (nrow(res) == 0 || sum(!is.na(res$NES)) == 0) {
      return(ggplot() +
        annotate("text", x = 0.5, y = 0.5, label = paste(ct, "\nNo significant kinases")) +
        theme_void() + ggtitle(ct))
    }
    dotplot(gsea_results[[ct]], showCategory = 15, title = ct) +
      theme(axis.text.y = element_text(size = 8))
  })
wrap_plots(plots, ncol = 2)
```

### NES Heatmap

```{r nes-heatmap, fig.width=12, fig.height=10}
# Extract NES values for significant kinases
all_results_cp <- names(gsea_results) |>
  map_dfr(function(ct) {
    gsea_results[[ct]]@result |>
      as_tibble() |>
      mutate(contrast = ct)
  })

# Get top kinases across all contrasts
top_kinases <- all_results_cp |>
  filter(p.adjust < 0.25) |>
  group_by(ID) |>
  summarize(min_fdr = min(p.adjust), .groups = "drop") |>
  arrange(min_fdr) |>
  head(30) |>
  pull(ID)

heatmap_data <- all_results_cp |>
  filter(ID %in% top_kinases) |>
  mutate(
    sig_label = case_when(
      p.adjust < 0.01 ~ "***",
      p.adjust < 0.05 ~ "**",
      p.adjust < 0.1 ~ "*",
      TRUE ~ ""
    )
  )

ggplot(heatmap_data, aes(x = contrast, y = fct_reorder(ID, NES), fill = NES)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sig_label), color = "black", size = 4) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    axis.text.y = element_text(size = 9)
  ) +
  labs(
    title = paste(params$analysis_type, "- Top Kinases by NES"),
    subtitle = "* FDR<0.1, ** FDR<0.05, *** FDR<0.01",
    x = "", y = "", fill = "NES"
  )
```

# Volcano Plot

```{r volcano-plot, fig.width=12, fig.height=8}
# Prepare data for volcano plot
volcano_data <- names(gsea_results) |>
  map_dfr(function(ct) {
    gsea_results[[ct]]@result |>
      as_tibble() |>
      mutate(contrast = ct)
  }) |>
  mutate(
    neg_log_fdr = -log10(pmax(p.adjust, 1e-10)),
    direction = case_when(
      NES > 0 ~ "Up",
      NES < 0 ~ "Down",
      TRUE ~ "NS"
    ),
    significant = p.adjust < 0.1
  )

ggplot(volcano_data, aes(x = NES, y = neg_log_fdr)) +
  geom_point(aes(color = direction, alpha = significant), size = 2) +
  geom_hline(yintercept = -log10(0.1), linetype = "dashed", color = "grey30") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey30") +
  geom_text(
    data = volcano_data |>
      filter(p.adjust < 0.05) |>
      group_by(contrast) |>
      slice_min(p.adjust, n = 5),
    aes(label = ID),
    size = 2.5,
    hjust = -0.1,
    check_overlap = TRUE
  ) +
  scale_color_manual(values = c("Up" = "red", "Down" = "blue", "NS" = "grey50")) +
  scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.3), guide = "none") +
  facet_wrap(~contrast, scales = "free") +
  theme_bw() +
  labs(
    title = paste(params$analysis_type, "- GSEA Volcano Plots"),
    subtitle = "Dashed line: FDR = 0.1; Labels: top 5 by FDR per contrast",
    x = "NES",
    y = "-log10(FDR)",
    color = "Direction"
  )
```

# Diagnostics

```{r diagnostic-pvalues}
pval_diag <- names(gsea_results) |>
  map_dfr(function(ct) {
    res <- gsea_results[[ct]]@result
    tibble(
      Contrast = ct,
      `Min p-value` = signif(min(res$pvalue, na.rm = TRUE), 3),
      `p < 0.05` = sum(res$pvalue < 0.05, na.rm = TRUE),
      `p < 0.01` = sum(res$pvalue < 0.01, na.rm = TRUE),
      Total = nrow(res)
    )
  })
knitr::kable(pval_diag, caption = paste("Raw p-value Distribution (", params$analysis_type, ")"))
```

# Export All GSEA Plots to PDF

```{r export-gsea-pdf, results='hide'}
# Export all GSEA enrichment plots to PDF
pdf_file <- file.path(params$output_dir, paste0("GSEA_plots_", params$analysis_type, ".pdf"))
pdf(pdf_file, width = 10, height = 6)

n_plots <- 0
for (ct in names(gsea_results)) {
  res <- gsea_results[[ct]]
  all_genesets <- res@result |>
    as_tibble() |>
    filter(p.adjust < 0.25) |>
    arrange(pvalue) |>
    pull(ID)

  for (geneset in all_genesets) {
    row <- res@result |> as_tibble() |> filter(ID == geneset)
    nes_val <- round(row$NES, 2)
    fdr <- signif(row$p.adjust, 2)

    p <- gseaplot2(res, geneSetID = geneset,
      title = paste0(ct, ": ", geneset, " (NES=", nes_val, ", FDR=", fdr, ")"))
    print(p)
    n_plots <- n_plots + 1
  }
}
dev.off()
cat("Exported", n_plots, "GSEA plots to:", pdf_file, "\n")
```

# GSEA Enrichment Plots {.tabset .tabset-pills}

Showing top 10 plots per contrast. **All `r n_plots` plots exported to PDF:** `r basename(pdf_file)`

```{r gsea-example-plots, results='asis', fig.width=10, fig.height=6}
for (ct in names(gsea_results)) {
  cat("\n\n### ", ct, " {.tabset}\n\n")

  res <- gsea_results[[ct]]
  top10 <- res@result |>
    as_tibble() |>
    arrange(pvalue) |>
    head(10) |>
    pull(ID)

  for (i in seq_along(top10)) {
    geneset <- top10[i]
    cat("\n\n#### ", geneset, "\n\n")

    row <- res@result |>
      as_tibble() |>
      filter(ID == geneset)
    nes_val <- round(row$NES, 2)
    fdr <- signif(row$p.adjust, 2)

    p <- gseaplot2(res, geneSetID = geneset,
      title = paste0(geneset, " (NES=", nes_val, ", FDR=", fdr, ")"))
    print(p)
    cat("\n\n")
  }
}
```

# All Results

```{r allResults}
# All kinases across all contrasts
all_results_dt <- names(gsea_results) |>
  map_dfr(function(ct) {
    gsea_results[[ct]]@result |>
      as_tibble() |>
      mutate(contrast = ct) |>
      select(contrast, kinase = ID, NES, pvalue, FDR = p.adjust, setSize)
  }) |>
  arrange(contrast, FDR) |>
  mutate(across(where(is.numeric), ~round(.x, 4)))

DT::datatable(all_results_dt,
  filter = "top",
  extensions = 'Buttons',
  options = list(pageLength = 15, scrollX = TRUE,
                 dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel')),
  caption = "All kinases across all contrasts")
```

# Export Results

```{r export}
dir.create(params$output_dir, recursive = TRUE, showWarnings = FALSE)

# Combine all results
all_results_export <- names(gsea_results) |>
  map_dfr(function(ct) {
    gsea_results[[ct]]@result |>
      as_tibble() |>
      mutate(contrast = ct) |>
      select(contrast, kinase = ID, NES, pvalue, FDR = p.adjust, setSize)
  })

# Export to Excel
export_list <- list(
  all_results = all_results_export |> arrange(contrast, FDR),
  significant = all_results_export |> filter(FDR < 0.1) |> arrange(contrast, FDR),
  summary = gsea_info
)

xlsx_file <- file.path(params$output_dir, paste0("KinaseLib_GSEA_", params$analysis_type, ".xlsx"))
writexl::write_xlsx(export_list, xlsx_file)
cat("Exported Excel:", xlsx_file, "\n")

# Export RDS with full clusterProfiler result objects
rds_file <- file.path(params$output_dir, paste0("KinaseLib_GSEA_", params$analysis_type, ".rds"))
saveRDS(gsea_results, rds_file)
cat("Exported RDS:", rds_file, "\n")
```

## Session Info

```{r session-info}
sessionInfo()
```
