---
title: "PTM Analysis - Sequence Logo"
subtitle: "`r params$sheet` Analysis"
author: "FGCZ"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  xlsx_file: "PTM_results.xlsx"
  sheet: "DPA"
  fdr: 0.05
  fc: 0.6
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    self_contained: true
  pdf_document:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)

suppressPackageStartupMessages({
  library(tidyverse)
  library(ggseqlogo)
  library(readxl)
  library(prophosqua)
})

is_docx <- knitr::pandoc_to() == "docx"
if (length(is_docx) == 0) {
  is_docx <- TRUE
}
```

# Introduction

This document performs sequence logo analysis on significantly regulated sites from **`r params$sheet`** analysis. Sequence motifs help identify active kinases driving PTM changes.

```{r analysis_description, results='asis'}
desc <- switch(params$sheet,
  "DPA" = "**DPA (Differential PTM Abundance)**: Raw PTM signal changes. Sequence motifs may reflect both abundance and stoichiometry effects.",
  "DPU" = "**DPU (Differential PTM Usage)**: Protein-normalized changes. Sequence motifs reflect genuine kinase activity changes.",
  "CF" = "**CF (CorrectFirst)**: Alternative normalization. Sequence motifs reflect activity changes with different correction approach."
)
cat(desc)
```

# Data Loading

```{r load_data}
message("Loading data from: ", params$xlsx_file, " (sheet: ", params$sheet, ")")
data <- readxl::read_xlsx(params$xlsx_file, sheet = params$sheet)

data_info <- tibble(
  Property = c("Excel File", "Sheet", "Rows", "Contrasts"),
  Value = c(basename(params$xlsx_file), params$sheet,
            nrow(data), paste(unique(data$contrast), collapse = ", "))
)
knitr::kable(data_info, caption = "Data Summary")
```

# Filter Significant Sites

Filter sites with |log2FC| > `r params$fc` and FDR < `r params$fdr`.

```{r filter_significant}
# Standardized column names: diff.site, FDR.site, SequenceWindow
significant_sites <- data |>
  dplyr::filter(
    FDR.site < params$fdr,
    abs(diff.site) > params$fc,
    !is.na(posInProtein),
    !is.na(SequenceWindow),
    !grepl("^_", SequenceWindow),
    !grepl("_$", SequenceWindow)
  ) |>
  dplyr::mutate(
    regulation = dplyr::case_when(
      diff.site > 0 ~ "upregulated",
      diff.site < 0 ~ "downregulated",
      TRUE ~ "no_change"
    )
  )

cat("Found", nrow(significant_sites), "significant sites\n")
```

## Count Significant Sites

```{r table_significant}
stopifnot("No significant sites found. Adjust fdr/log2fc thresholds in config." = nrow(significant_sites) > 0)

tx <- as.data.frame(with(significant_sites, table(contrast, regulation, modAA)))
capt <- paste0("Number of significantly regulated sites by contrast, residue, and regulation direction (", params$sheet, ").")

if (is_docx) {
  ft <- flextable::flextable(tx) |>
    flextable::fontsize(part = "all", size = 9) |>
    flextable::set_table_properties(width = 1, layout = "fixed", opts_word = list(split = FALSE)) |>
    flextable::width(width = c(2.5, 1.2, 0.8, 1.0)) |>
    flextable::set_caption(capt)
  ft
} else {
  tx |>
    knitr::kable(caption = capt) |>
    kableExtra::kable_styling(font_size = 9, latex_options = "scale_down")
}
```

## Validate Sequence Window

Ensure the central residue matches the modified amino acid.

```{r validate_seq_window}
significant_sites$central_aa <- toupper(substr(significant_sites$SequenceWindow, 8, 8))
significant_sites <- significant_sites |>
  dplyr::filter(central_aa == modAA)

cat("After validation:", nrow(significant_sites), "sites remain\n")
```

# Sequence Logo Analysis

## Generate Sequence Logos

```{r fig_seqlogo, fig.width=9, fig.height=12, fig.cap="Sequence logos for significantly regulated sites by contrast and regulation direction."}
seq_list <- significant_sites |>
  dplyr::mutate(.grp = paste(contrast, regulation, sep = "_")) |>
  dplyr::group_by(.grp) |>
  dplyr::summarize(
    seqs = list(toupper(SequenceWindow)),
    .groups = "drop"
  ) |>
  with(setNames(seqs, .grp))

if (length(seq_list) > 0) {
  ggseqlogo(
    seq_list,
    ncol = 2,
    seq_type = "aa",
    method = "probability"
  )
} else {
  cat("No significant sites found for sequence logo generation.\n")
}
```

# Difference Logo Analysis

Visualize the difference in amino acid enrichment between upregulated and downregulated sites.

```{r fig_difflogo, fig.width=10, fig.height=10, fig.cap="Difference Logos (Upregulated - Downregulated)"}
p_diff <- prophosqua::plot_diff_logo(significant_sites)

if (!is.null(p_diff)) {
  print(p_diff)
} else {
  cat("No contrasts with both upregulated and downregulated sites found for difference logo.\n")
}
```

# Results Summary

```{r summary}
summary_info <- tibble(
  Metric = c("Analysis Type", "FDR Threshold", "FC Threshold",
             "Total Significant Sites", "Upregulated", "Downregulated"),
  Value = c(params$sheet, params$fdr, params$fc,
            nrow(significant_sites),
            sum(significant_sites$regulation == "upregulated"),
            sum(significant_sites$regulation == "downregulated"))
)
knitr::kable(summary_info, caption = "Analysis Summary")
```

# Session Info

```{r sessionInfo}
sessionInfo()
```
