---
title: "DPA and DPU Integration Analysis"
author:
  - FGCZ
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
params:
  output_base: !r paste0("PTM_", format(Sys.Date(), "%Y%m%d"))
  utils_script: "src/dea_utils.R"
  phospho_dea_dir: "DEA_setup/DEA_20260109_WUphospho_SHP2_vsn"
  protein_dea_dir: "DEA_setup/DEA_20260109_WUprot_SHP2_vsn"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r setupglobal, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)

suppressPackageStartupMessages({
  library(prolfquapp)
  library(prophosqua)
  library(dplyr)
})

if (file.exists("~/projects/prophosqua")) {
  devtools::load_all("~/projects/prophosqua", quiet = TRUE)
}
```

# Introduction

This analysis integrates total proteome and phosphoproteome DEA results to compute:

- **DPA** (Differential PTM Abundance): Raw phosphosite signal changes
- **DPU** (Differential PTM Usage): Protein-normalized changes (site - protein) reflecting modification stoichiometry

# Setup

```{r b1specifyinputs}
library(prophosqua)

wu_id <- "CustomPhosphoAnalysis"
fgcz_project <- "PTM_analysis"
oid_fgcz <- "fgcz_project"
datetoday <- format(Sys.Date(), "%Y%m%d")
project_dir <- "."

# Use output_base param for date-stamped output directories
res_dir_dpa <- file.path(params$output_base, "PTM_DPA")
res_dir_dpu <- file.path(params$output_base, "PTM_DPU")
```

```{r b2createoutputdir}
descri <- wu_id
if (!dir.exists(file.path(project_dir, res_dir_dpa))) {
  dir.create(file.path(project_dir, res_dir_dpa), recursive = TRUE)
}
if (!dir.exists(file.path(project_dir, res_dir_dpu))) {
  dir.create(file.path(project_dir, res_dir_dpu), recursive = TRUE)
}
```

# Load DEA Results

```{r definePaths}
source(params$utils_script)

# Get Excel files from direct DEA directory paths
tot_file <- get_dea_xlsx(params$protein_dea_dir)
ptm_file <- get_dea_xlsx(params$phospho_dea_dir)

stopifnot(file.exists(tot_file))
stopifnot(file.exists(ptm_file))
```

```{r b4loaddata}
required_cols <- c("protein_Id", "protein_length", "contrast")
tot_res <- prophosqua::load_and_preprocess_data(tot_file, required_cols)
tot_res <- prophosqua::filter_contaminants(tot_res)
phospho_res <- prophosqua::load_and_preprocess_data(ptm_file, required_cols)
phospho_res <- prophosqua::filter_contaminants(phospho_res)
```

# DPA: Integrate PTM and Protein Data

```{r b5combinedata}
join_column <- c(
  "protein_Id" = "protein_Id",
  "contrast",
  "description",
  "protein_length"
)
suffix_a <- ".site"
suffix_b <- ".protein"
phospho_res <- phospho_res |> filter(!is.na(FDR))

combined_site_prot <- dplyr::left_join(
  phospho_res,
  tot_res,
  by = join_column,
  suffix = c(suffix_a, suffix_b)
)
```

## Match Rate

```{r b5matchrate}
match_rates <- combined_site_prot |>
  group_by(contrast) |>
  summarize(
    total_sites = n(),
    matched_sites = sum(!is.na(diff.protein)),
    match_rate = round(matched_sites / total_sites * 100, 1)
  )

knitr::kable(
  match_rates,
  col.names = c("Contrast", "Total Sites", "Matched Sites", "Match Rate (%)"),
  caption = "Match rates between PTM sites and proteins."
)
```

# DPU: Compute Differential PTM Usage

DPU calculates protein-normalized PTM changes:

- Effect size: $\Delta_I = \log_2FC_{PTM} - \log_2FC_{Protein}$
- Standard error: $SE_I = \sqrt{SE_{PTM}^2 + SE_{Protein}^2}$

```{r b8computeptmusage}
combined_test_diff <- prophosqua::test_diff(phospho_res, tot_res, join_column = join_column)

# Add 'site' alias for compatibility with template (new format uses protein_Id_site)
if (!"site" %in% colnames(combined_test_diff) && "protein_Id_site" %in% colnames(combined_test_diff)) {
  combined_test_diff <- combined_test_diff |> dplyr::mutate(site = protein_Id_site)
}
```

# Export Results

```{r storeptmusagexlsx}
writexl::write_xlsx(
  list(combinedStats = combined_test_diff),
  path = file.path(project_dir, res_dir_dpu, "Result_DPU.xlsx")
)

writexl::write_xlsx(
  list(combinedSiteProteinData = combined_site_prot),
  path = file.path(project_dir, res_dir_dpa, "Result_DPA.xlsx")
)

# Save intermediate data for DPU overview rendering (separate step)
saveRDS(
  combined_test_diff,
  file = file.path(project_dir, res_dir_dpu, "combined_test_diff.rds")
)
```

# Output Files

- `PTM_DPA/Result_DPA.xlsx` - Differential PTM Abundance (raw PTM changes)
- `PTM_DPU/Result_DPU.xlsx` - Differential PTM Usage (protein-normalized changes)

# Session Info

```{r sessioninfo}
sessionInfo()
```
