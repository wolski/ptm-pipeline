---
title: "`r params$title`"
params:
  folder: "PTM_DPA"
  title: "DPA Results"
  description: "Differential PTM Abundance"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

## `r params$description`

This page provides links to all analysis outputs in the `r params$folder` directory.

```{r discover_files}
# Get all files in the folder
files <- list.files(params$folder, full.names = FALSE)

# Group by type
reports <- files[grepl("\\.html$", files) & !grepl("^index\\.html$", files)]
data_files <- files[grepl("\\.xlsx$", files)]
pdfs <- files[grepl("\\.pdf$", files)]
ora_up <- files[grepl("_ORA_.*_UP_", files)]
ora_down <- files[grepl("_ORA_.*_DOWN_", files)]
ora_bg <- files[grepl("_ORA_.*_background", files)]

# Get files from subfolders
ksea_reports <- if (dir.exists(file.path(params$folder, "KSEA"))) {
  list.files(file.path(params$folder, "KSEA"), pattern = "\\.html$", full.names = FALSE)
} else character(0)

ptmsea_reports <- if (dir.exists(file.path(params$folder, "PTMSEA"))) {
  list.files(file.path(params$folder, "PTMSEA"), pattern = "\\.html$", full.names = FALSE)
} else character(0)

ptmsea_pdfs <- if (dir.exists(file.path(params$folder, "PTMSEA"))) {
  list.files(file.path(params$folder, "PTMSEA"), pattern = "\\.pdf$", full.names = FALSE)
} else character(0)

kinaselib_reports <- if (dir.exists(file.path(params$folder, "KinaseLib"))) {
  list.files(file.path(params$folder, "KinaseLib"), pattern = "\\.html$", full.names = FALSE)
} else character(0)

kinaselib_pdfs <- if (dir.exists(file.path(params$folder, "KinaseLib"))) {
  list.files(file.path(params$folder, "KinaseLib"), pattern = "\\.pdf$", full.names = FALSE)
} else character(0)

# Helper to extract contrast name from filename
extract_contrast <- function(filename, prefix) {
  # Pattern: PREFIX_TYPE_CONTRAST_...
  gsub(paste0("^", prefix, "_(GSEA|ORA)_(.+?)(_UP_|_DOWN_|_background|\\.).*"), "\\2", filename)
}
```

```{r reports, results='asis'}
if (length(reports) > 0) {
  cat("## Analysis Reports\n\n")
  cat("| Report | Description |\n")
  cat("|--------|-------------|\n")
  for (f in sort(reports)) {
    desc <- dplyr::case_when(
      grepl("n_to_c", f) ~ "N-to-C plots showing PTM positions along proteins",
      grepl("seqlogo", f) ~ "Sequence logo analysis of significant sites",
      grepl("Result_", f) ~ "Interactive results overview",
      grepl("Analysis_short", f) ~ "Main analysis report",
      TRUE ~ "Analysis report"
    )
    cat(sprintf("| [%s](%s) | %s |\n", f, f, desc))
  }
  cat("\n")
}
```

```{r data_files, results='asis'}
if (length(data_files) > 0) {
  cat("## Data Files\n\n")
  cat("| File | Description |\n")
  cat("|------|-------------|\n")
  for (f in sort(data_files)) {
    desc <- dplyr::case_when(
      grepl("Result_DPA", f) ~ "Complete DPA results with all statistics",
      grepl("Result_DPU", f) ~ "Complete DPU results with all statistics",
      grepl("CorrectFirst", f) ~ "CorrectFirst analysis results",
      TRUE ~ "Results spreadsheet"
    )
    cat(sprintf("| [%s](%s) | %s |\n", f, f, desc))
  }
  cat("\n")
}
```

```{r pdfs, results='asis'}
if (length(pdfs) > 0) {
  cat("## PDF Plots\n\n")
  cat("| File | Description |\n")
  cat("|------|-------------|\n")
  for (f in sort(pdfs)) {
    desc <- dplyr::case_when(
      grepl("MultiContrast", f) ~ "Multi-contrast comparison plots",
      grepl("Expression", f) ~ "Differential expression plots",
      grepl("Usage", f) ~ "Differential usage plots",
      TRUE ~ "Visualization plots"
    )
    cat(sprintf("| [%s](%s) | %s |\n", f, f, desc))
  }
  cat("\n")
}
```


```{r ora, results='asis'}
if (length(ora_up) > 0 || length(ora_down) > 0) {
  cat("## ORA Files\n\n")
  cat("Gene lists for Over-Representation Analysis.\n\n")

  # Get unique contrasts
  all_ora <- c(ora_up, ora_down, ora_bg)
  contrasts <- unique(gsub("^.*_ORA_(.+?)(_UP_|_DOWN_|_background).*", "\\1", all_ora))

  cat("| Contrast | Upregulated | Downregulated | Background |\n")
  cat("|----------|-------------|---------------|------------|\n")

  for (ctr in sort(contrasts)) {
    up_file <- ora_up[grepl(paste0("_", ctr, "_UP_"), ora_up)]
    down_file <- ora_down[grepl(paste0("_", ctr, "_DOWN_"), ora_down)]
    bg_file <- ora_bg[grepl(paste0("_", ctr, "_background"), ora_bg)]

    up_link <- if (length(up_file) > 0) sprintf("[UP](%s)", up_file[1]) else "-"
    down_link <- if (length(down_file) > 0) sprintf("[DOWN](%s)", down_file[1]) else "-"
    bg_link <- if (length(bg_file) > 0) sprintf("[background](%s)", bg_file[1]) else "-"

    cat(sprintf("| %s | %s | %s | %s |\n", ctr, up_link, down_link, bg_link))
  }
  cat("\n")
}
```

```{r ksea_reports, results='asis'}
if (length(ksea_reports) > 0) {
  cat("## KSEA Analysis\n\n")
  cat("Kinase-Substrate Enrichment Analysis results.\n\n")
  cat("| Report | Description |\n")
  cat("|--------|-------------|\n")
  for (f in sort(ksea_reports)) {
    desc <- dplyr::case_when(
      grepl("Analysis_KSEA\\.html", f) ~ "KSEA input file generation",
      grepl("KSEA_.*_results", f) ~ "KSEA enrichment results",
      TRUE ~ "KSEA analysis"
    )
    cat(sprintf("| [%s](KSEA/%s) | %s |\n", f, f, desc))
  }
  cat("\n")
}
```

```{r ptmsea_reports, results='asis'}
if (length(ptmsea_reports) > 0 || length(ptmsea_pdfs) > 0) {
  cat("## PTM-SEA Analysis\n\n")
  cat("Post-Translational Modification Signature Enrichment Analysis results.\n\n")

  if (length(ptmsea_reports) > 0) {
    cat("### Reports\n\n")
    cat("| Report | Description |\n")
    cat("|--------|-------------|\n")
    for (f in sort(ptmsea_reports)) {
      cat(sprintf("| [%s](PTMSEA/%s) | PTM-SEA enrichment results |\n", f, f))
    }
    cat("\n")
  }

  if (length(ptmsea_pdfs) > 0) {
    cat("### PDF Plots\n\n")
    cat("| File | Description |\n")
    cat("|------|-------------|\n")
    for (f in sort(ptmsea_pdfs)) {
      desc <- dplyr::case_when(
        grepl("GSEA_plots", f) ~ "All GSEA enrichment plots",
        TRUE ~ "Analysis plots"
      )
      cat(sprintf("| [%s](PTMSEA/%s) | %s |\n", f, f, desc))
    }
    cat("\n")
  }
}
```


```{r kinaselib_reports, results='asis'}
if (length(kinaselib_reports) > 0 || length(kinaselib_pdfs) > 0) {
  cat("## KinaseLib Analysis\n\n")
  cat("Kinase activity inference using [KinaseLib](https://github.com/Phosphoproteomics-Analysis/KinaseLib) substrate library.\n\n")

  if (length(kinaselib_reports) > 0) {
    cat("### Reports\n\n")
    cat("| Report | Description |\n")
    cat("|--------|-------------|\n")
    for (f in sort(kinaselib_reports)) {
      desc <- dplyr::case_when(
        grepl("kinase_activity", f, ignore.case = TRUE) ~ "Kinase activity scores and enrichment",
        grepl("substrate", f, ignore.case = TRUE) ~ "Substrate mapping results",
        grepl("heatmap", f, ignore.case = TRUE) ~ "Kinase activity heatmap",
        grepl("Vis_MEA", f) ~ "MEA visualization and summary",
        grepl("KinaseLib", f) ~ "KinaseLib GSEA analysis",
        TRUE ~ "KinaseLib analysis results"
      )
      cat(sprintf("| [%s](KinaseLib/%s) | %s |\n", f, f, desc))
    }
    cat("\n")
  }

  if (length(kinaselib_pdfs) > 0) {
    cat("### PDF Plots\n\n")
    cat("| File | Description |\n")
    cat("|------|-------------|\n")
    for (f in sort(kinaselib_pdfs)) {
      desc <- dplyr::case_when(
        grepl("GSEA_plots", f) ~ "All GSEA enrichment plots",
        TRUE ~ "Analysis plots"
      )
      cat(sprintf("| [%s](KinaseLib/%s) | %s |\n", f, f, desc))
    }
    cat("\n")
  }
}
```

---

*Generated on `r Sys.Date()`*
