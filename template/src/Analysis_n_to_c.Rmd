---
title: "PTM Analysis - N-to-C Plots"
subtitle: "`r params$analysis_type` Analysis"
author: "FGCZ"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  xlsx_file: "PTM_results.xlsx"
  sheet: "DPA"
  analysis_type: "dpa"
  output_dir: NULL
  fdr: 0.05
  fc: 0.6
  max_fig: 10000
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    self_contained: true
  pdf_document:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)

suppressPackageStartupMessages({
  library(prophosqua)
  library(tidyverse)
  library(readxl)
  library(patchwork)
})

# Load development version if available
if (file.exists("~/projects/prophosqua")) {
  devtools::load_all("~/projects/prophosqua", quiet = TRUE)
}

max_fig <- params$max_fig
```

# Introduction

This document generates N-to-C plots for **`r toupper(params$analysis_type)`** analysis.

```{r analysis_description, results='asis'}
desc <- switch(params$analysis_type,
  "dpa" = "**DPA (Differential PTM Abundance)**: Raw PTM signal changes without protein abundance correction. Shows both site-level and protein-level fold changes.",
  "dpu" = "**DPU (Differential PTM Usage)**: Protein-normalized PTM changes (model-first approach). Reflects genuine modification stoichiometry changes.",
  "cf" = "**CF (CorrectFirst)**: Alternative protein-correction approach where abundances are normalized before statistical modeling."
)
cat(desc)
```

# Data Loading

```{r load_data}
message("Loading data from: ", params$xlsx_file, " (sheet: ", params$sheet, ")")
data <- readxl::read_xlsx(params$xlsx_file, sheet = params$sheet)

data_info <- tibble(
  Property = c("Excel File", "Sheet", "Analysis Type", "Rows", "Contrasts"),
  Value = c(basename(params$xlsx_file), params$sheet, toupper(params$analysis_type),
            nrow(data), paste(unique(data$contrast), collapse = ", "))
)
knitr::kable(data_info, caption = "Data Summary")
```

```{r prepare_data}
# Prepare data for plotting functions
# prophosqua functions expect specific column names

if (params$analysis_type == "dpa") {
  # DPA: n_to_c_expression_multicontrast expects diff.site, FDR.site, diff.protein
  # Our standardized format already has these column names
  plot_data <- data |>
    dplyr::mutate(
      # Add imputation_status if not present (required by function)
      modelName.site = if ("modelName.site" %in% names(data)) modelName.site else "observed"
    )
} else {
  # DPU/CF: n_to_c_usage_multicontrast expects diff_diff, FDR_I
  # Rename from standardized format
  plot_data <- data |>
    dplyr::rename(
      diff_diff = diff.site,
      FDR_I = FDR.site,
      tstatistic_I = statistic.site
    ) |>
    dplyr::mutate(
      # Add columns expected by n_to_c_usage_multicontrast
      modelName.site = "observed",
      modelName.protein = "observed"
    )
}

all_contrasts <- unique(plot_data$contrast)
cat("Found", length(all_contrasts), "contrasts:", paste(all_contrasts, collapse = ", "), "\n")
```

# Generate N-to-C Plots

**Filtering criteria:** Proteins are included if they contain at least one PTM site with FDR < `r params$fdr` and |log2 fold change| > `r params$fc`.

```{r generate_plots, results='hide'}
if (params$analysis_type == "dpa") {
  # DPA: Use expression plotting (shows protein + site)
  plot_result <- n_to_c_expression_multicontrast(
    plot_data,
    FDR_threshold = params$fdr,
    fc_threshold = params$fc,
    max_plots = max_fig
  )
} else {
  # DPU/CF: Use usage plotting (shows site only)
  plot_result <- n_to_c_usage_multicontrast(
    plot_data,
    FDR_threshold = params$fdr,
    fc_threshold = params$fc,
    max_plots = max_fig
  )
}

n_plots <- nrow(plot_result)
stopifnot("No significant sites found. Adjust fdr/log2fc thresholds in config." = n_plots > 0)
cat("Generated", n_plots, "multi-contrast plots\n")
```

## Example Plots

Showing 2 example plots in the HTML report. All `r n_plots` plots are exported to PDF.

```{r display_examples, fig.width=12, fig.height=10, results='asis'}
n_examples <- min(2, n_plots)

if (n_plots > 0) {
  for (i in seq_len(n_examples)) {
    cat("\n\n### ", plot_result$protein_Id[i], "\n\n")
    print(plot_result$plot[[i]])
    cat("\n\n")
  }
} else {
  cat("No significant proteins found with the current filtering criteria.\n")
}
```

# Export Plots

```{r export_pdf, results='hide'}
# Use explicit output_dir if provided, otherwise use xlsx directory
pdf_dir <- if (!is.null(params$output_dir)) {
  params$output_dir
} else {
  dirname(params$xlsx_file)
}

if (!dir.exists(pdf_dir)) {
  dir.create(pdf_dir, recursive = TRUE)
}

# Determine output filename based on analysis type
pdf_name <- switch(params$analysis_type,
  "dpa" = "Site_differential_Expression_MultiContrast.pdf",
  "dpu" = "Site_differential_UsageChange_MultiContrast.pdf",
  "cf"  = "Site_differential_CorrectFirst_MultiContrast.pdf"
)

pdf_path <- file.path(pdf_dir, pdf_name)

if (n_plots > 0) {
  pdf(pdf_path, width = 14, height = 10)
  for (i in seq_len(n_plots)) {
    print(plot_result$plot[[i]])
  }
  dev.off()
  cat("Exported", n_plots, "plots to:", pdf_path, "\n")
} else {
  cat("No plots to export.\n")
}
```

# Results Summary

```{r summary}
summary_info <- tibble(
  Metric = c("Analysis Type", "Total Proteins", "Plots Generated",
             "Shown in HTML", "Exported to PDF", "FDR Threshold", "FC Threshold"),
  Value = c(toupper(params$analysis_type), n_distinct(plot_data$protein_Id),
            n_plots, n_examples, n_plots, params$fdr, params$fc)
)
knitr::kable(summary_info, caption = "Analysis Summary")

if (n_plots > 0) {
  cat("\nPDF exported to:", pdf_path, "\n")
}
```

# Session Info

```{r sessionInfo}
sessionInfo()
```
